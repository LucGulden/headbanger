rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Collection des utilisateurs
    match /users/{userId} {
      // Lecture : tout le monde peut lire les profils publics
      allow read: if true;

      // Écriture : seulement le propriétaire du profil
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Collection des albums (cache Spotify)
    match /albums/{albumId} {
      // Lecture : tout le monde peut lire
      allow read: if true;

      // Écriture : n'importe quel utilisateur authentifié peut créer/modifier
      // (nécessaire pour le cache automatique lors des recherches)
      allow write: if request.auth != null;
    }

    // Collection des albums des utilisateurs (collection + wishlist)
    match /user_albums/{userAlbumId} {
      // Lecture : utilisateurs authentifiés
      allow read: if request.auth != null;

      // Création : utilisateur authentifié si userId correspond
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Modification/Suppression : propriétaire seulement
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Collection des follows (système social)
    match /follows/{followId} {
      // Lecture : utilisateurs authentifiés
      allow read: if request.auth != null;

      // Création : utilisateur authentifié si followerId correspond
      allow create: if request.auth != null && request.resource.data.followerId == request.auth.uid;

      // Modification : seulement l'utilisateur suivi (pour accepter des demandes)
      allow update: if request.auth != null && resource.data.followingId == request.auth.uid;

      // Suppression : le follower ou le suivi peuvent supprimer
      allow delete: if request.auth != null &&
                       (resource.data.followerId == request.auth.uid ||
                        resource.data.followingId == request.auth.uid);
    }

    // Collection des collections d'utilisateurs (DEPRECATED - utiliser user_albums)
    match /collections/{userId}/albums/{albumId} {
      // Lecture : le propriétaire ou si le profil est public
      allow read: if request.auth != null &&
                     (request.auth.uid == userId ||
                      get(/databases/$(database)/documents/users/$(userId)).data.isPrivate == false);

      // Écriture : seulement le propriétaire
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Collection des wishlists
    match /wishlists/{userId}/albums/{albumId} {
      // Lecture : le propriétaire ou si le profil est public
      allow read: if request.auth != null &&
                     (request.auth.uid == userId ||
                      get(/databases/$(database)/documents/users/$(userId)).data.isPrivate == false);

      // Écriture : seulement le propriétaire
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Collection des posts (Phase 7 - Feed social)
    match /posts/{postId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if request.auth != null;

      // Création : seulement si userId correspond à l'utilisateur authentifié
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Modification : permettre l'update des compteurs (likesCount, commentsCount)
      // Update autorisé pour tout utilisateur authentifié (nécessaire pour les compteurs)
      allow update: if request.auth != null;

      // Suppression : seulement le propriétaire du post
      allow delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // Collection des likes (Phase 7 - Feed social)
    match /likes/{likeId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if request.auth != null;

      // Création : seulement si userId correspond à l'utilisateur authentifié
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Suppression : le propriétaire du like OU l'auteur du post associé
      allow delete: if request.auth != null &&
                       (resource.data.userId == request.auth.uid ||
                        get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.userId == request.auth.uid);
    }

    // Collection des commentaires (Phase 7 - Feed social)
    match /comments/{commentId} {
      // Lecture : tous les utilisateurs authentifiés
      allow read: if request.auth != null;

      // Création : seulement si userId correspond à l'utilisateur authentifié
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      // Suppression : le propriétaire du commentaire OU l'auteur du post associé
      allow delete: if request.auth != null &&
                       (resource.data.userId == request.auth.uid ||
                        get(/databases/$(database)/documents/posts/$(resource.data.postId)).data.userId == request.auth.uid);
    }

    // Collection des feeds personnalisés (Phase 7 - Architecture fan-out)
    // Structure: user_feeds/{userId}/posts/{postId}
    match /user_feeds/{userId}/posts/{postId} {
      // Lecture : seulement le propriétaire du feed
      allow read: if request.auth != null && request.auth.uid == userId;

      // Création : tout utilisateur authentifié peut ajouter au feed de quelqu'un
      // (nécessaire pour le fan-out lors de la création de posts)
      allow create: if request.auth != null;

      // Suppression : le propriétaire du feed OU l'auteur du post
      // Les deux conditions sont nécessaires :
      // - userId == request.auth.uid : pour supprimer de son propre feed (unfollow)
      // - resource.data.userId == request.auth.uid : pour supprimer tous ses posts (deletePost avec collectionGroup)
      allow delete: if request.auth != null &&
                       (request.auth.uid == userId ||
                        resource.data.userId == request.auth.uid);

      // Pas d'update : les pointeurs de feed sont immuables
      allow update: if false;
    }
  }
}
